–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –≤ Django ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –∏—Å–∫–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å —É—á–µ—Ç–æ–º –≤–∞–∂–Ω–æ—Å—Ç–∏ —Å–ª–æ–≤, —Ñ–æ—Ä–º—ã —Å–ª–æ–≤ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏. Django –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞, –æ—Å–æ–±–µ–Ω–Ω–æ —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö PostgreSQL, –∫–æ—Ç–æ—Ä–∞—è –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ç–∞–∫–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.

1. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ PostgreSQL
Django –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ PostgreSQL: tsvector (—Ç–µ–∫—Å—Ç, –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –∫ –ø–æ–∏—Å–∫—É) –∏ tsquery (–ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å). –° –≤–µ—Ä—Å–∏–∏ Django 1.10 –ø–æ—è–≤–∏–ª—Å—è –º–æ–¥—É–ª—å django.contrib.postgres.search, –≤–∫–ª—é—á–∞—é—â–∏–π:

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
SearchVector ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø–æ–ª–µ –º–æ–¥–µ–ª–∏ –≤ tsvector.

SearchQuery ‚Äî —Å–æ–∑–¥–∞—ë—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.

SearchRank ‚Äî –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

SearchHeadline ‚Äî –≤—ã–¥–µ–ª—è–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (—Å Django 4.0+).

2. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

from django.contrib.postgres.search import SearchVector
from myapp.models import Article

# –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫
Article.objects.annotate(
    search=SearchVector('title', 'body'),
).filter(search='Django')

# –° —É—á–µ—Ç–æ–º –≤–µ—Å–∞ –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
from django.contrib.postgres.search import SearchQuery, SearchRank

vector = SearchVector('title', weight='A') + SearchVector('body', weight='B')
query = SearchQuery('django tutorial')
Article.objects.annotate(
    rank=SearchRank(vector, query),
).filter(rank__gte=0.3).order_by('-rank')

3. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è
–î–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å GIN-–∏–Ω–¥–µ–∫—Å:


from django.contrib.postgres.indexes import GinIndex

class Article(models.Model):
    title = models.CharField(max_length=200)
    body = models.TextField()

    class Meta:
        indexes = [
            GinIndex(fields=['title', 'body']),
        ]
–ò–ª–∏ —á–µ—Ä–µ–∑ SearchVectorField (–Ω–∞—á–∏–Ω–∞—è —Å Django 3.2+):

python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
from django.contrib.postgres.search import SearchVectorField
from django.db.models import Index

class Article(models.Model):
    ...
    search_vector = SearchVectorField(null=True)

    class Meta:
        indexes = [GinIndex(fields=["search_vector"])]
–û–±–Ω–æ–≤–ª—è—Ç—å search_vector –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é SearchVector + UpdateQuerySet.

4. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å PostgreSQL.

–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å config='russian' –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ.

–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SearchHeadline.



GinIndex ‚Äî —ç—Ç–æ —Ç–∏–ø –∏–Ω–¥–µ–∫—Å–∞ –≤ PostgreSQL, –∫–æ—Ç–æ—Ä—ã–π –æ—Å–æ–±–µ–Ω–Ω–æ —Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –º–∞—Å—Å–∏–≤–∞–º, JSON-–ø–æ–ª—è–º –∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –ø–æ–∏—Å–∫—É.

–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Django –∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ GinIndex –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ SearchVector –∏–ª–∏ SearchVectorField.

üîç –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç GIN
GIN = Generalized Inverted Index
–≠—Ç–æ –æ–±–æ–±—â—ë–Ω–Ω—ã–π –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å. –û–Ω —Ö—Ä–∞–Ω–∏—Ç –Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è, –∫–∞–∫ –æ–±—ã—á–Ω—ã–π B-tree, –∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏, –≥–¥–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –≠—Ç–æ –æ—á–µ–Ω—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –º–Ω–æ–∂–µ—Å—Ç–≤—É –∑–Ω–∞—á–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—è.

üìå –ó–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω
–ë–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º, –ø–æ—Ç–æ–º—É —á—Ç–æ –±–∞–∑–∞ –±—É–¥–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É. GIN –∏–Ω–¥–µ–∫—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å —Å—Ç—Ä–æ–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –Ω—É–∂–Ω—ã–µ —Å–ª–æ–≤–∞, –¥–∞–∂–µ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –æ–±—ä—ë–º–µ —Ç–µ–∫—Å—Ç–∞.


üß± –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Django

from django.contrib.postgres.indexes import GinIndex
from django.db import models

class Article(models.Model):
    title = models.CharField(max_length=200)
    body = models.TextField()

    class Meta:
        indexes = [
            GinIndex(fields=['title', 'body']),  # –ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        ]
–ò–ª–∏, –ª—É—á—à–µ –≤—Å–µ–≥–æ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–µ —Å SearchVectorField:

from django.contrib.postgres.search import SearchVectorField

class Article(models.Model):
    ...
    search_vector = SearchVectorField(null=True)

    class Meta:
        indexes = [GinIndex(fields=["search_vector"])]


‚ö†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ PostgreSQL.

–¢—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã –ø–æ–ª—è –±—ã–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —Ç–∏–ø–∞ (text, SearchVectorField, array, –∏ —Ç.–ø.).

–û—á–µ–Ω—å –ø–æ–ª–µ–∑–µ–Ω –ø—Ä–∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–∏—Å–∫–µ, –æ—Å–æ–±–µ–Ω–Ω–æ —Å –±–æ–ª—å—à–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏.